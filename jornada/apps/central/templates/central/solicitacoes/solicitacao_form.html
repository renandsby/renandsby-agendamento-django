{% extends "central/base.html" %}
{% load shared_components %}


{% block body %}


{% Form form=form enctype="multipart/form-data" %}

{% arg titulo %}
  {% if form.instance.pk %}
  Editar Solicitação
  {% else  %}
  Cadastrar Solicitação
  {% endif %}
{% endarg %}

{% if form.instance.get_status_display == "Em Processamento" %}
  <span class="fs-6 badge bg-secondary">Solicitação Em Processamento</span>
{% elif form.instance.get_status_display == "Realizado" %}
  <span class="fs-6 badge bg-success">Solicitação Já Realizada</span>
{% elif form.instance.get_status_display == "Negado" %}
  <span class="fs-6  badge bg-danger">Solicitação Negada</span>
{% endif %}

{% Fieldset class="bg-light px-3 py-4 my-3" legenda_transparente="True" legenda="Validação"%}
{% comment %} <small class="fw-light text-muted">Selecione o Adolescente e o Processo para validar a Solicitação</small>  {% endcomment %}
  <div class="row">
    <div class="col-md-8 py-1">
      {% LabeledInput field=form.adolescente %} {% /LabeledInput %}
    </div>
    <div class="col-md-4 py-1">
      {% LabeledInput field=form.processo %}{% /LabeledInput %}
    </div>
  </div>
  <div class="row">
    <div class="col-md-4">
      {% LabeledInput field=form.medida %}{% /LabeledInput %}
    </div>
    <div class="col-md-4">
      {% LabeledInput field=form.acao_solicitada %}{% /LabeledInput %}
    </div>
    <div class="col-md-4">
      {% LabeledInput field=form.status %}{% /LabeledInput %}
    </div>
  </div>
  <div class="row">
    <div class="col-12 py-1">
      {% LabeledInput field=form.observacoes %} {% /LabeledInput %}
    </div>
  </div>

{% /Fieldset %}

{% if not form.instance.validada %}
{% Fieldset class="bg-light px-3 py-4 my-3" legenda_transparente="True" legenda="Informações do Solicitante"%}
  <div class="row">
    <div class="col-md-7 py-1">
      {% LabeledInput field=form.nome_adolescente %} {% /LabeledInput %}
    </div>
    <div class="col-md-5 py-1">
      {% LabeledInput field=form.data_nascimento %}{% /LabeledInput %}
    </div>
  </div>
  <div class="row">
    <div class="col-md-7 py-1">
      {% LabeledInput field=form.nome_mae %} {% /LabeledInput %}
    </div>
    <div class="col-md-5 py-1">
      {% LabeledInput field=form.numero_processo %}{% /LabeledInput %}
    </div>
  </div>
{% /Fieldset %}

{% Fieldset class="bg-light px-3 py-4 my-3" legenda_transparente="True" legenda="Alterações"%}
<div class="row">
  <div class="col-md-7 py-1">
    {% LabeledInput field=form.alteracao_solicitada %} {% /LabeledInput %}
    {% comment %} <small class="fw-light text-muted">&nbsp Desmarque para validar a Solicitação.</small> {% endcomment %}
  </div>
</div>

<div class="row">
  <div class="col-12 py-1">
    {% LabeledInput field=form.mensagem_alteracao %} {% /LabeledInput %}
  </div>
</div>

{% /Fieldset %}
 {% endif %}
{% Fieldset class="bg-light px-3 py-4 my-3" legenda_transparente="True" legenda="Anexos"%}

{% InlineFormset formset=anexos %}
{% arg empty_form %}
  <div class="row justify-content-center px-0 mb-2 m-0">
    {{ anexos.empty_form.id }}

    <div class="col-lg-3 px-1 mt-auto mb-2">
      {% LabeledInput field=anexos.empty_form.anexo %}{% /LabeledInput %}
    </div>

    <div class="col-lg-3 px-1 mt-auto mb-2">
      {% LabeledInput field=anexos.empty_form.tipo_anexo %}{% /LabeledInput %}
    </div>

    <div class="col-lg-3 px-1 mt-auto mb-2">
      {% LabeledInput field=anexos.empty_form.descricao %}{% /LabeledInput %}
    </div>

     <div class="col-lg-2 px-1 mt-1 mb-2">
      {% LabeledInput field=anexos.empty_form.DELETE %}{% /LabeledInput %}
    </div>

    {{ anexos.empty_form.solicitacao }}
  </div>
{% endarg %}

{% for anexo in anexos %}
  {% FormErrors form=anexo %}{% /FormErrors %}
  <div class="row justify-content-center px-0 mb-2 m-0">
    {{ anexo.id }}

    <div class="col-lg-3 px-1 mt-auto mb-2">
      {% LabeledInput field=anexo.anexo %}{% /LabeledInput %}
    </div>

    <div class="col-lg-3 px-1 mt-auto mb-2">
      {% LabeledInput field=anexo.tipo_anexo %}{% /LabeledInput %}
    </div>

    <div class="col-lg-3 px-1 mt-auto mb-2">
      {% LabeledInput field=anexo.descricao %}{% /LabeledInput %}
    </div>

    <div class="col-lg-2 px-1 mt-auto mb-2">
      {% if anexo.instance.criado_por == request.user or not anexo.instance.pk %}
          {% LabeledInput field=anexo.DELETE %}{% /LabeledInput %}
      {% else %}
          <small class="fst-italic" style="color: #777474;"> criado por: {{anexo.instance.criado_por}} </small>
      {% endif %}
    </div> 
    

    {{ anexo.solicitacao }}
  </div>
{% endfor %}



{% /InlineFormset%}

{% /Fieldset %}

{% if form.instance.status > 2 %}
    {% arg botao_salvar %}{% endarg %}
{% endif %}

{% arg botoes_extra %}
  
  {% url 'central:solicitacao-list' as voltar_url %}
  {% BotaoVoltar url=voltar_url %}{% /BotaoVoltar %}


{% endarg %}
  
  
  <p></p>
  

{% /Form %}


{% endblock %}


{% block js %}

<script>
  $("#id_adolescente").change(function () {
    
      var id_adolescente = $(this).val();  
      if(id_adolescente == "") {
        var selectbox = $('#id_processo');
        selectbox.find('option').remove();
        selectbox.append("<option value='' selected=''>---------</option>")
      }else{

          $.ajax({                       
            url: '/api/processos/?adolescente='+id_adolescente,                    // set the url of the request (= localhost:8000/hr/ajax/load-cities/)
            type: 'GET',
            dataType: 'json', // added data type
            success: function(data) {
              if (data != null) {
                var results = data['results']
                var selectbox = $('#id_processo');
                selectbox.find('option').remove();
                if (results.length > 0){
                  selectbox.append("<option value='' selected=''>Selecione o Processo</option>")
                }else{
                  selectbox.append("<option value='' selected=''>Nenhum Processo Encontrado</option>")
                }
                $.each(data['results'], function (i, d) {
                    $('<option>').val(d.id).text(d.str_sem_nome).appendTo(selectbox);
                });
            }
    
    
          }
        });
      }
     
  
    });

    $( document ).ready(function() {
      var selected = $('#id_processo selected');
      if(!selected){
        $('#id_adolescente').trigger('change');
      }
    });

</script>

{% endblock %}